<?php
/* SVN FILE: $Id$ */
/**
 * Short description for file.
 *
 * Long description for file
 *
 * PHP versions 4 and 5
 *
 * CakePHP(tm) :  Rapid Development Framework (http://www.cakephp.org)
 * Copyright 2005-2008, Cake Software Foundation, Inc. (http://www.cakefoundation.org)
 *
 * Licensed under The MIT License
 * Redistributions of files must retain the above copyright notice.
 *
 * @filesource
 * @copyright     Copyright 2005-2008, Cake Software Foundation, Inc. (http://www.cakefoundation.org)
 * @link          http://www.cakefoundation.org/projects/info/cakephp CakePHP(tm) Project
 * @package       cake
 * @subpackage    cake.app.webroot
 * @since         CakePHP(tm) v 0.2.9
 * @version       $Revision$
 * @modifiedby    $LastChangedBy$
 * @lastmodified  $Date$
 * @license       http://www.opensource.org/licenses/mit-license.php The MIT License
 */
/**
 * Use the DS to separate the directories in other defines
 */
	if (!defined('DS')) {
		define('DS', DIRECTORY_SEPARATOR);
	}
/**
 * These defines should only be edited if you have cake installed in
 * a directory layout other than the way it is distributed.
 * When using custom settings be sure to use the DS and do not add a trailing DS.
 */

/**
 * The full path to the directory which holds "app", WITHOUT a trailing DS.
 *
 */
	if (!defined('ROOT')) {
		define('ROOT', dirname(dirname(dirname(__FILE__))));
	}
/**
 * The actual directory name for the "app".
 *
 */
	if (!defined('APP_DIR')) {
		define('APP_DIR', basename(dirname(dirname(__FILE__))));
	}
/**
 * The absolute path to the "cake" directory, WITHOUT a trailing DS.
 *
 */
	if (!defined('CAKE_CORE_INCLUDE_PATH')) {
		define('CAKE_CORE_INCLUDE_PATH', ROOT);
	}


/**
 * Editing below this line should NOT be necessary.
 * Change at your own risk.
 *
 */
	if (!defined('WEBROOT_DIR')) {
		define('WEBROOT_DIR', basename(dirname(__FILE__)));
	}
	if (!defined('WWW_ROOT')) {
		define('WWW_ROOT', dirname(__FILE__) . DS);
	}
	if (!defined('CORE_PATH')) {
		if (function_exists('ini_set') && ini_set('include_path', CAKE_CORE_INCLUDE_PATH . PATH_SEPARATOR . ROOT . DS . APP_DIR . DS . PATH_SEPARATOR . ini_get('include_path'))) {
			define('APP_PATH', null);
			define('CORE_PATH', null);
		} else {
			define('APP_PATH', ROOT . DS . APP_DIR . DS);
			define('CORE_PATH', CAKE_CORE_INCLUDE_PATH . DS);
		}
	}
	if (!include(CORE_PATH . 'cake' . DS . 'bootstrap.php')) {
		trigger_error("CakePHP core could not be found.  Check the value of CAKE_CORE_INCLUDE_PATH in APP/webroot/index.php.  It should point to the directory containing your " . DS . "cake core directory and your " . DS . "vendors root directory.", E_USER_ERROR);
	}


	if (isset($_GET['url']) && $_GET['url'] === 'favicon.ico') {
		return;
	} else {

		if(file_exists(TMP.'maintenance'.DS.'maintenance2.ctp')){
			include TMP.'maintenance'.DS.'maintenance2.ctp';
			exit;
		}

        // メンテナンス用処理追加 start
        $maintStartTime = '2012/08/24 04:00';    // メンテナンス開始時刻
        $maintEndTime = '2013/08/24 05:00';      // メンテナンス終了時刻
        $blogUrlFp = 'http://m.ameba.jp/m/themeEntryList.do?unm=bartown&themeId=10045169452';    // FP用ブログURL
        $blogUrlSp = 'http://s.ameblo.jp/bartown/theme-10045169452.html';    // SP用ブログURL
        // メンテナンス期間中か判定
        if (strtotime($maintStartTime) < time() && time() <= strtotime($maintEndTime)) {
            // リクエストされたURIをコントローラ名を抽出
            $requestUri = ltrim($_SERVER['REQUEST_URI'], '/');
            $sepUriSla = explode('/', $requestUri);
            $controller = $sepUriSla[0];
            // メンテ中のアメーバからのAPIアクセスは503番を返す
            if ($controller == 'api') {
                header('HTTP/1.0 503 Server Unavailable');
                exit;
            }

            $remote_addr = false;
            // $_SERVERからIPアドレスを取得
            if (isset($_SERVER['HTTP_X_FORWARDED_FOR'])) {
                $remote_addr = $_SERVER['HTTP_X_FORWARDED_FOR'];
            } else if (isset($_SERVER['REMOTE_ADDR'])) {
                $remote_addr = $_SERVER['REMOTE_ADDR'];
            }

            // アメーバが関連の施設のIPアドレスなら通す
            switch ($remote_addr) {
                case '61.121.214.170':
                case '124.32.6.234':
                case '122.212.216.66':
                case '127.0.0.1':          // 自分自身
                case '1.112.64.193':
                case '192.168.30.16':      // aoki add(VPN経由)
                case '118.21.158.120':     // CAAD_IP
                case '203.141.129.127':
                case '210.188.218.113':
                case '124.36.209.20':      // アライブ美竹
                case '124.39.126.66':      // マークシティー
                case '125.206.200.170':    // マークシティー
                case '124.35.136.52':      // ガーデンタワー
                case '61.121.217.60':
                    $Dispatcher = new Dispatcher();
                    $Dispatcher->dispatch($url);
                    exit;
            }

            // 内部IPからのアクセスの場合は通す
            if (substr($remote_addr, 0, 3) == '10.') {
                $Dispatcher = new Dispatcher();
                $Dispatcher->dispatch($url);
                exit;
            }

            // 内部IPからのアクセスの場合は通す
            if (substr($remote_addr, 0, 4) == '192.') {
                $Dispatcher = new Dispatcher();
                $Dispatcher->dispatch($url);
                exit;
            }

            // 携帯のキャリア判定用のクラスを読み込み
            if (!class_exists('lib3gk')) {
                require_once(VENDORS . 'ecw' . DS . 'lib3gk.php');
            }

            $lib3gk = new Lib3gk();
            // 一部のmuidだけメンテナンスに行かないように変更
            switch ($lib3gk->get_uid()) {
                case '05005013446903_ex.ezweb.ne.jp':    // 田邊ガラケ
                case '05005013397282_vg.ezweb.ne.jp':    // 本橋ガラケ
                case 'a31X8i1BLmV2sJI4':                 // 平野ガラケ
                case '5EX2yYM':                          // QuunappガラケNo.7
                case '05005013384898_ev.ezweb.ne.jp':    // 青木ガラケ
                case '05005013577450_hr.ezweb.ne.jp':    // 田代ガラケ
                case 'a3nOdxwLz9CDfVrq':                 // 渡邉ガラケ
                case '05005015493797_nz.ezweb.ne.jp':    // 植木ガラケ
                case '7qT00DM':
                case '05005013397095_er.ezweb.ne.jp':
                case '05005013564558_ew.ezweb.ne.jp':
                case '05005013577369_gd.ezweb.ne.jp':
                case '05005013578509_vx.ezweb.ne.jp':
                case '05005013564304_ef.ezweb.ne.jp':
                case 'a10Sty2etlfrZeb2':
                case '05004017097685_ga.ezweb.ne.jp':
                case '05005013367721_ek.ezweb.ne.jp':
                case 'IFm2w6N':
                case '05005013397046_vm.ezweb.ne.jp':
                case '05005013397064_eb.ezweb.ne.jp':
                case '05005013578547_ep.ezweb.ne.jp':
                case '05005013368000_ex.ezweb.ne.jp':
                case '05005013397030_hv.ezweb.ne.jp':
                case 'IFw01FB':
                case 'a2dCA2Q3lIrpVLGr':
                case '05005013578617_hh.ezweb.ne.jp':
                case '05005013578520_ea.ezweb.ne.jp':    //喜納
                // case 'a3RbYNPrhyCLXQhe':                // QuunApp 貸出機 No.5
                case '05005013447110_vd.ezweb.ne.jp':
                case '05005016018918_nz.ezweb.ne.jp':
                case '05005013397055_vu.ezweb.ne.jp':
                    $Dispatcher = new Dispatcher();
                    $Dispatcher->dispatch($url);
                    exit;
            }

            // 上記以外はメンテ画面を表示
            require_once(WWW_ROOT . 'index.maintenance.php');
            return;
        }
        // メンテナンス用処理追加 end

		$Dispatcher = new Dispatcher();

		$Dispatcher->dispatch($url);
	}
	if (Configure::read() > 0) {
		echo "<!-- " . round(getMicrotime() - $TIME_START, 4) . "s -->";
	}
